<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Build a Thing Video App</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  </head>

  <body>
    <div id="app">
      <header class="bg-pink-600 p-2 flex flex-row justify-center">
        <div id="publishers"></div>
      </header>
      <main style="display: grid; grid-template-columns: auto 300px; gap: 2em;">
        <div class="p-2">
          <div id="subscribers" class="flex flex-row flex-wrap" style="gap: 8px;"></div>
        </div>
        <div class="bg-gray-100 p-2 flex flex-col" style="height: calc(100vh - 88px)">
          <form class="border-b-2 border-gray-300 pb-2" @submit.prevent="lockRoom">
            <input :class="{ 'bg-gray-300': security.roomLocked, 'bg-white': !security.roomLocked }" class="w-full shadow appearance-none rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" type="text" id="access-code" placeholder="Access Code" :disabled="security.roomLocked" v-model="security.inputAccessCode"  />
            <button id="lock-button" :class="{ 'bg-red-500': security.roomLocked, 'hover:bg-red-700': security.roomLocked, 'bg-green-500': !security.roomLocked, 'hover:bg-green-700': !security.roomLocked, }" class="w-full text-white font-bold py-2 px-4 rounded">{{ security.roomLocked ? "Click to Unlock" : "Click to Lock" }}</button>
          </form>
          <div ref="messages" class="flex-1 overflow-y-scroll">
            <ul>
              <li v-for="item in messaging.messages" class="bg-white p-2 rounded break-all my-2">
                <label class="text-sm mb-1">{{item.username}}</label>
                <div>{{item.message}}</div>
              </li>
            </ul>
          </div>
          <form class="border-t-2 border-gray-300 pt-2" @submit.prevent="submitMessage">
            <input class="bg-white w-full shadow appearance-none rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" type="text" id="message" placeholder="New Message..." v-model="messaging.newMessage" />
            <button class="bg-pink-600 w-full text-white font-bold py-2 px-4 rounded">Send</button>
          </form>
        </div>
      </main>
    </div>

    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script>
      const app = new Vue({
        el: '#app',
        data: {
          connection: {
            session: undefined,
            camera: undefined,
            subscribers: [],
          },
          security: {
            roomLocked: false,
            inputAccessCode: '',
          },
          messaging: {
            messages: [],
            newMessage: ''
          },
          resp: undefined
        },
        async created() {
          this.resp = await fetch(`/api/session?room=${this.params.id}&code=${this.params.code}`).then(r => r.json())
          const { apiKey, sessionId, token, locked, access } = this.resp
          if(!access) window.location.replace(`/access-required?id=${this.params.id}&username=${this.params.username}`)

          this.connection.camera = OT.initPublisher('publishers', {
            mirror: false,
            name: this.params.username,
            insertMode: 'append',
            width: 128,
            height: 72
          })
          this.security.roomLocked = locked
          this.setLock(this.security.roomLocked,(this.params.code ? this.params.code : ""))

          this._initSession(apiKey, sessionId, token)
          this._subscribeStreamCreated()
          this._subscribeStreamDestroyed()
          this._subscribeSignal()
        },
        methods: {
          _initSession(apiKey, sessionId, token) {
            this.connection.session = OT.initSession(apiKey, sessionId)
            this.connection.session.connect(token, () => { this.connection.session.publish(this.connection.camera) })
          },
          _subscribeStreamCreated() {
            this.connection.session.on('streamCreated', event => {
              this.connection.subscribers.push(event.stream)
              this.connection.session.subscribe(event.stream, 'subscribers', {
                insertMode: 'append',
                width: 320,
                height: 240
              })
            })
          },
          _subscribeStreamDestroyed() {
            this.connection.session.on('streamDestroyed', event => {
              this.connection.subscribers = this.connection.subscribers.filter(sub => sub.id != event.stream.id)
            })
          },
          _subscribeSignal() {
            this.connection.session.on('signal', event => {
              switch (event.type) {
                case 'signal:message':
                  this.messaging.messages.push(JSON.parse(event.data))
                  Vue.nextTick(() => {
                    const messages = this.$refs.messages;
                    messages.scrollTop = messages.scrollHeight
                  })
                  break
                case 'signal:lock':
                  const lockData = JSON.parse(event.data)
                  this.setLock(lockData.lock,lockData.code)
                  break
              }
            })
          },
          setLock(locked, code) {
            this.security.inputAccessCode = code
            this.security.roomLocked = locked
          },
          submitMessage() {
            if(this.messaging.newMessage) {
              const chatname = this.params.username.split(" - ")[0]
              this.connection.session.signal({
                data: JSON.stringify({username: chatname, message: this.messaging.newMessage }),
                type: 'message'
              })
              this.messaging.newMessage = ''
            }
          },
          async lockRoom() {
            const { apiKey, sessionId, token, locked } = await fetch(`/api/session?room=${this.params.id}&lock=${!this.security.roomLocked}&code=${this.security.inputAccessCode}`).then(r => r.json())
            this.security.roomLocked = locked
            this.connection.session.signal({
              data: JSON.stringify({lock: locked, code: this.security.inputAccessCode }),
              type: 'lock'
            })
            this.setLock(this.security.roomLocked, this.security.inputAccessCode)
          }
        },
        computed: {
          params() {
            return Object.fromEntries(new URLSearchParams(location.search));
          }
        }
      })
    </script>
  </body>
</html>
